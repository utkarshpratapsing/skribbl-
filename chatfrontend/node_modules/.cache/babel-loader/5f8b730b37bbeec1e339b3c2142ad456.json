{"ast":null,"code":"function _createForOfIteratorHelperLoose(o, allowArrayLike) {\n  var it;\n\n  if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) {\n    if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") {\n      if (it) o = it;\n      var i = 0;\n      return function () {\n        if (i >= o.length) return {\n          done: true\n        };\n        return {\n          done: false,\n          value: o[i++]\n        };\n      };\n    }\n\n    throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n  }\n\n  it = o[Symbol.iterator]();\n  return it.next.bind(it);\n}\n\nfunction _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return _arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(o);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);\n}\n\nfunction _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n\n  for (var i = 0, arr2 = new Array(len); i < len; i++) {\n    arr2[i] = arr[i];\n  }\n\n  return arr2;\n}\n\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n\n    return target;\n  };\n\n  return _extends.apply(this, arguments);\n}\n\nfunction _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return self;\n}\n\nfunction _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  subClass.__proto__ = superClass;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nimport React, { PureComponent } from \"react\";\nimport PropTypes from \"prop-types\";\nimport { LazyBrush } from \"lazy-brush\";\nimport { Catenary } from \"catenary-curve\";\nimport ResizeObserver from \"resize-observer-polyfill\";\nimport CoordinateSystem, { IDENTITY } from \"./coordinateSystem\";\nimport drawImage from \"./drawImage\";\nimport { DefaultState } from \"./interactionStateMachine\";\nimport makePassiveEventOption from \"./makePassiveEventOption\";\n\nfunction midPointBtw(p1, p2) {\n  return {\n    x: p1.x + (p2.x - p1.x) / 2,\n    y: p1.y + (p2.y - p1.y) / 2\n  };\n}\n\nvar canvasStyle = {\n  display: \"block\",\n  position: \"absolute\"\n}; // The order of these is important: grid > drawing > temp > interface\n\nvar canvasTypes = [\"grid\", \"drawing\", \"temp\", \"interface\"];\nvar dimensionsPropTypes = process.env.NODE_ENV !== \"production\" ? PropTypes.oneOfType([PropTypes.number, PropTypes.string]) : {};\nvar boundsProp = process.env.NODE_ENV !== \"production\" ? PropTypes.shape({\n  min: PropTypes.number.isRequired,\n  max: PropTypes.number.isRequired\n}) : {};\n\nvar CanvasDraw = /*#__PURE__*/function (_PureComponent) {\n  _inheritsLoose(CanvasDraw, _PureComponent); ///// public API /////////////////////////////////////////////////////////////\n\n\n  function CanvasDraw(props) {\n    var _this;\n\n    _this = _PureComponent.call(this, props) || this;\n\n    _defineProperty(_assertThisInitialized(_this), \"undo\", function () {\n      var lines = [];\n\n      if (_this.lines.length) {\n        lines = _this.lines.slice(0, -1);\n      } else if (_this.erasedLines.length) {\n        lines = _this.erasedLines.pop();\n      }\n\n      _this.clearExceptErasedLines();\n\n      _this.simulateDrawingLines({\n        lines: lines,\n        immediate: true\n      });\n\n      _this.triggerOnChange();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"eraseAll\", function () {\n      _this.erasedLines.push([].concat(_this.lines));\n\n      _this.clearExceptErasedLines();\n\n      _this.triggerOnChange();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"clear\", function () {\n      _this.erasedLines = [];\n\n      _this.clearExceptErasedLines();\n\n      _this.resetView();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"resetView\", function () {\n      return _this.coordSystem.resetView();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"setView\", function (view) {\n      return _this.coordSystem.setView(view);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getSaveData\", function () {\n      // Construct and return the stringified saveData object\n      return JSON.stringify({\n        lines: _this.lines,\n        width: _this.props.canvasWidth,\n        height: _this.props.canvasHeight\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getDataURL\", function (fileType, useBgImage, backgroundColour) {\n      // Get a reference to the \"drawing\" layer of the canvas\n      var canvasToExport = _this.canvas.drawing;\n      var context = canvasToExport.getContext(\"2d\"); //cache height and width\n\n      var width = canvasToExport.width;\n      var height = canvasToExport.height; //get the current ImageData for the canvas\n\n      var storedImageData = context.getImageData(0, 0, width, height); //store the current globalCompositeOperation\n\n      var compositeOperation = context.globalCompositeOperation; //set to draw behind current content\n\n      context.globalCompositeOperation = \"destination-over\"; // If \"useBgImage\" has been set to true, this takes precedence over the background colour parameter\n\n      if (useBgImage) {\n        if (!_this.props.imgSrc) return \"Background image source not set\"; // Write the background image\n\n        _this.drawImage();\n      } else if (backgroundColour != null) {\n        //set background color\n        context.fillStyle = backgroundColour; //fill entire canvas with background colour\n\n        context.fillRect(0, 0, width, height);\n      } // If the file type has not been specified, default to PNG\n\n\n      if (!fileType) fileType = \"png\"; // Export the canvas to data URL\n\n      var imageData = canvasToExport.toDataURL(\"image/\" + fileType); //clear the canvas\n\n      context.clearRect(0, 0, width, height); //restore it with original / cached ImageData\n\n      context.putImageData(storedImageData, 0, 0); //reset the globalCompositeOperation to what it was\n\n      context.globalCompositeOperation = compositeOperation;\n      return imageData;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"loadSaveData\", function (saveData, immediate) {\n      if (immediate === void 0) {\n        immediate = _this.props.immediateLoading;\n      }\n\n      if (typeof saveData !== \"string\") {\n        throw new Error(\"saveData needs to be of type string!\");\n      }\n\n      var _JSON$parse = JSON.parse(saveData),\n          lines = _JSON$parse.lines,\n          width = _JSON$parse.width,\n          height = _JSON$parse.height;\n\n      if (!lines || typeof lines.push !== \"function\") {\n        throw new Error(\"saveData.lines needs to be an array!\");\n      }\n\n      _this.clear();\n\n      if (width === _this.props.canvasWidth && height === _this.props.canvasHeight) {\n        _this.simulateDrawingLines({\n          lines: lines,\n          immediate: immediate\n        });\n      } else {\n        // we need to rescale the lines based on saved & current dimensions\n        var scaleX = _this.props.canvasWidth / width;\n        var scaleY = _this.props.canvasHeight / height;\n        var scaleAvg = (scaleX + scaleY) / 2;\n\n        _this.simulateDrawingLines({\n          lines: lines.map(function (line) {\n            return _extends({}, line, {\n              points: line.points.map(function (p) {\n                return {\n                  x: p.x * scaleX,\n                  y: p.y * scaleY\n                };\n              }),\n              brushRadius: line.brushRadius * scaleAvg\n            });\n          }),\n          immediate: immediate\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"componentWillUnmount\", function () {\n      _this.canvasObserver.unobserve(_this.canvasContainer);\n\n      _this.canvas[\"interface\"] && _this.canvas[\"interface\"].removeEventListener(\"wheel\", _this.handleWheel);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleWheel\", function (e) {\n      _this.interactionSM = _this.interactionSM.handleMouseWheel(e, _assertThisInitialized(_this));\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleDrawStart\", function (e) {\n      _this.interactionSM = _this.interactionSM.handleDrawStart(e, _assertThisInitialized(_this));\n      _this.mouseHasMoved = true;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleDrawMove\", function (e) {\n      _this.interactionSM = _this.interactionSM.handleDrawMove(e, _assertThisInitialized(_this));\n      _this.mouseHasMoved = true;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleDrawEnd\", function (e) {\n      _this.interactionSM = _this.interactionSM.handleDrawEnd(e, _assertThisInitialized(_this));\n      _this.mouseHasMoved = true;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"applyView\", function () {\n      if (!_this.ctx.drawing) {\n        return;\n      }\n\n      canvasTypes.map(function (name) {\n        return _this.ctx[name];\n      }).forEach(function (ctx) {\n        _this.clearWindow(ctx);\n\n        var m = _this.coordSystem.transformMatrix;\n        ctx.setTransform(m.a, m.b, m.c, m.d, m.e, m.f);\n      });\n\n      if (!_this.deferRedrawOnViewChange) {\n        _this.drawGrid(_this.ctx.grid);\n\n        _this.redrawImage();\n\n        _this.loop({\n          once: true\n        });\n\n        var lines = _this.lines;\n        _this.lines = [];\n\n        _this.simulateDrawingLines({\n          lines: lines,\n          immediate: true\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleCanvasResize\", function (entries) {\n      var saveData = _this.getSaveData();\n\n      _this.deferRedrawOnViewChange = true;\n\n      try {\n        for (var _iterator = _createForOfIteratorHelperLoose(entries), _step; !(_step = _iterator()).done;) {\n          var entry = _step.value;\n          var _entry$contentRect = entry.contentRect,\n              width = _entry$contentRect.width,\n              height = _entry$contentRect.height;\n\n          _this.setCanvasSize(_this.canvas[\"interface\"], width, height);\n\n          _this.setCanvasSize(_this.canvas.drawing, width, height);\n\n          _this.setCanvasSize(_this.canvas.temp, width, height);\n\n          _this.setCanvasSize(_this.canvas.grid, width, height);\n\n          _this.coordSystem.documentSize = {\n            width: width,\n            height: height\n          };\n\n          _this.drawGrid(_this.ctx.grid);\n\n          _this.drawImage();\n\n          _this.loop({\n            once: true\n          });\n        }\n\n        _this.loadSaveData(saveData, true);\n      } finally {\n        _this.deferRedrawOnViewChange = false;\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"clampPointToDocument\", function (point) {\n      if (_this.props.clampLinesToDocument) {\n        return {\n          x: Math.max(Math.min(point.x, _this.props.canvasWidth), 0),\n          y: Math.max(Math.min(point.y, _this.props.canvasHeight), 0)\n        };\n      } else {\n        return point;\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"redrawImage\", function () {\n      _this.image && _this.image.complete && drawImage({\n        ctx: _this.ctx.grid,\n        img: _this.image\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"simulateDrawingLines\", function (_ref) {\n      var lines = _ref.lines,\n          immediate = _ref.immediate; // Simulate live-drawing of the loaded lines\n      // TODO use a generator\n\n      var curTime = 0;\n      var timeoutGap = immediate ? 0 : _this.props.loadTimeOffset;\n      lines.forEach(function (line) {\n        var points = line.points,\n            brushColor = line.brushColor,\n            brushRadius = line.brushRadius; // Draw all at once if immediate flag is set, instead of using setTimeout\n\n        if (immediate) {\n          // Draw the points\n          _this.drawPoints({\n            points: points,\n            brushColor: brushColor,\n            brushRadius: brushRadius\n          }); // Save line with the drawn points\n\n\n          _this.points = points;\n\n          _this.saveLine({\n            brushColor: brushColor,\n            brushRadius: brushRadius\n          });\n\n          return;\n        } // Use timeout to draw\n\n\n        var _loop = function _loop(i) {\n          curTime += timeoutGap;\n          window.setTimeout(function () {\n            _this.drawPoints({\n              points: points.slice(0, i + 1),\n              brushColor: brushColor,\n              brushRadius: brushRadius\n            });\n          }, curTime);\n        };\n\n        for (var i = 1; i < points.length; i++) {\n          _loop(i);\n        }\n\n        curTime += timeoutGap;\n        window.setTimeout(function () {\n          // Save this line with its props instead of this.props\n          _this.points = points;\n\n          _this.saveLine({\n            brushColor: brushColor,\n            brushRadius: brushRadius\n          });\n        }, curTime);\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"setCanvasSize\", function (canvas, width, height) {\n      canvas.width = width;\n      canvas.height = height;\n      canvas.style.width = width;\n      canvas.style.height = height;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"drawPoints\", function (_ref2) {\n      var points = _ref2.points,\n          brushColor = _ref2.brushColor,\n          brushRadius = _ref2.brushRadius;\n      _this.ctx.temp.lineJoin = \"round\";\n      _this.ctx.temp.lineCap = \"round\";\n      _this.ctx.temp.strokeStyle = brushColor;\n\n      _this.clearWindow(_this.ctx.temp);\n\n      _this.ctx.temp.lineWidth = brushRadius * 2;\n      var p1 = points[0];\n      var p2 = points[1];\n\n      _this.ctx.temp.moveTo(p2.x, p2.y);\n\n      _this.ctx.temp.beginPath();\n\n      for (var i = 1, len = points.length; i < len; i++) {\n        // we pick the point between pi+1 & pi+2 as the\n        // end point and p1 as our control point\n        var midPoint = midPointBtw(p1, p2);\n\n        _this.ctx.temp.quadraticCurveTo(p1.x, p1.y, midPoint.x, midPoint.y);\n\n        p1 = points[i];\n        p2 = points[i + 1];\n      } // Draw last line as a straight line while\n      // we wait for the next point to be able to calculate\n      // the bezier control point\n\n\n      _this.ctx.temp.lineTo(p1.x, p1.y);\n\n      _this.ctx.temp.stroke();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"saveLine\", function (_temp) {\n      var _ref3 = _temp === void 0 ? {} : _temp,\n          brushColor = _ref3.brushColor,\n          brushRadius = _ref3.brushRadius;\n\n      if (_this.points.length < 2) return; // Save as new line\n\n      _this.lines.push({\n        points: [].concat(_this.points),\n        brushColor: brushColor || _this.props.brushColor,\n        brushRadius: brushRadius || _this.props.brushRadius\n      }); // Reset points array\n\n\n      _this.points.length = 0; // Copy the line to the drawing canvas\n\n      _this.inClientSpace([_this.ctx.drawing, _this.ctx.temp], function () {\n        _this.ctx.drawing.drawImage(_this.canvas.temp, 0, 0, _this.canvas.drawing.width, _this.canvas.drawing.height);\n      }); // Clear the temporary line-drawing canvas\n\n\n      _this.clearWindow(_this.ctx.temp);\n\n      _this.triggerOnChange();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"triggerOnChange\", function () {\n      _this.props.onChange && _this.props.onChange(_assertThisInitialized(_this));\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"clearWindow\", function (ctx) {\n      _this.inClientSpace([ctx], function () {\n        return ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"clearExceptErasedLines\", function () {\n      _this.lines = [];\n      _this.valuesChanged = true;\n\n      _this.clearWindow(_this.ctx.drawing);\n\n      _this.clearWindow(_this.ctx.temp);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"loop\", function (_temp2) {\n      var _ref4 = _temp2 === void 0 ? {} : _temp2,\n          _ref4$once = _ref4.once,\n          once = _ref4$once === void 0 ? false : _ref4$once;\n\n      if (_this.mouseHasMoved || _this.valuesChanged) {\n        var pointer = _this.lazy.getPointerCoordinates();\n\n        var brush = _this.lazy.getBrushCoordinates();\n\n        _this.drawInterface(_this.ctx[\"interface\"], pointer, brush);\n\n        _this.mouseHasMoved = false;\n        _this.valuesChanged = false;\n      }\n\n      if (!once) {\n        window.requestAnimationFrame(function () {\n          _this.loop();\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"inClientSpace\", function (ctxs, action) {\n      ctxs.forEach(function (ctx) {\n        ctx.save();\n        ctx.setTransform(IDENTITY.a, IDENTITY.b, IDENTITY.c, IDENTITY.d, IDENTITY.e, IDENTITY.f);\n      });\n\n      try {\n        action();\n      } finally {\n        ctxs.forEach(function (ctx) {\n          return ctx.restore();\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"drawImage\", function () {\n      if (!_this.props.imgSrc) return; // Load the image\n\n      _this.image = new Image(); // Prevent SecurityError \"Tainted canvases may not be exported.\" #70\n\n      _this.image.crossOrigin = \"anonymous\"; // Draw the image once loaded\n\n      _this.image.onload = _this.redrawImage;\n      _this.image.src = _this.props.imgSrc;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"drawGrid\", function (ctx) {\n      if (_this.props.hideGrid) return;\n\n      _this.clearWindow(ctx);\n\n      var gridSize = 25;\n      var _this$coordSystem$can = _this.coordSystem.canvasBounds,\n          viewMin = _this$coordSystem$can.viewMin,\n          viewMax = _this$coordSystem$can.viewMax;\n      var minx = Math.floor(viewMin.x / gridSize - 1) * gridSize;\n      var miny = Math.floor(viewMin.y / gridSize - 1) * gridSize;\n      var maxx = viewMax.x + gridSize;\n      var maxy = viewMax.y + gridSize;\n      ctx.beginPath();\n      ctx.setLineDash([5, 1]);\n      ctx.setLineDash([]);\n      ctx.strokeStyle = _this.props.gridColor;\n      ctx.lineWidth = _this.props.gridLineWidth;\n\n      if (!_this.props.hideGridX) {\n        var countX = minx;\n        var gridSizeX = _this.props.gridSizeX;\n\n        while (countX < maxx) {\n          countX += gridSizeX;\n          ctx.moveTo(countX, miny);\n          ctx.lineTo(countX, maxy);\n        }\n\n        ctx.stroke();\n      }\n\n      if (!_this.props.hideGridY) {\n        var countY = miny;\n        var gridSizeY = _this.props.gridSizeY;\n\n        while (countY < maxy) {\n          countY += gridSizeY;\n          ctx.moveTo(minx, countY);\n          ctx.lineTo(maxx, countY);\n        }\n\n        ctx.stroke();\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"drawInterface\", function (ctx, pointer, brush) {\n      if (_this.props.hideInterface) return;\n\n      _this.clearWindow(ctx); // Draw brush preview\n\n\n      ctx.beginPath();\n      ctx.fillStyle = _this.props.brushColor;\n      ctx.arc(brush.x, brush.y, _this.props.brushRadius, 0, Math.PI * 2, true);\n      ctx.fill(); // Draw mouse point (the one directly at the cursor)\n\n      ctx.beginPath();\n      ctx.fillStyle = _this.props.catenaryColor;\n      ctx.arc(pointer.x, pointer.y, 4, 0, Math.PI * 2, true);\n      ctx.fill(); // Draw catenary\n\n      if (_this.lazy.isEnabled()) {\n        ctx.beginPath();\n        ctx.lineWidth = 2;\n        ctx.lineCap = \"round\";\n        ctx.setLineDash([2, 4]);\n        ctx.strokeStyle = _this.props.catenaryColor;\n\n        _this.catenary.drawToCanvas(_this.ctx[\"interface\"], brush, pointer, _this.chainLength);\n\n        ctx.stroke();\n      } // Draw brush point (the one in the middle of the brush preview)\n\n\n      ctx.beginPath();\n      ctx.fillStyle = _this.props.catenaryColor;\n      ctx.arc(brush.x, brush.y, 2, 0, Math.PI * 2, true);\n      ctx.fill();\n    });\n\n    _this.canvas = {};\n    _this.ctx = {};\n    _this.catenary = new Catenary();\n    _this.points = [];\n    _this.lines = [];\n    _this.erasedLines = [];\n    _this.mouseHasMoved = true;\n    _this.valuesChanged = true;\n    _this.isDrawing = false;\n    _this.isPressing = false;\n    _this.deferRedrawOnViewChange = false;\n    _this.interactionSM = new DefaultState();\n    _this.coordSystem = new CoordinateSystem({\n      scaleExtents: props.zoomExtents,\n      documentSize: {\n        width: props.canvasWidth,\n        height: props.canvasHeight\n      }\n    });\n\n    _this.coordSystem.attachViewChangeListener(_this.applyView.bind(_assertThisInitialized(_this)));\n\n    return _this;\n  }\n\n  var _proto = CanvasDraw.prototype; ///// private API ////////////////////////////////////////////////////////////\n  ///// React Lifecycle\n\n  _proto.componentDidMount = function componentDidMount() {\n    var _this2 = this;\n\n    this.lazy = new LazyBrush({\n      radius: this.props.lazyRadius * window.devicePixelRatio,\n      enabled: true,\n      initialPoint: {\n        x: window.innerWidth / 2,\n        y: window.innerHeight / 2\n      }\n    });\n    this.chainLength = this.props.lazyRadius * window.devicePixelRatio;\n    this.canvasObserver = new ResizeObserver(function (entries, observer) {\n      return _this2.handleCanvasResize(entries, observer);\n    });\n    this.canvasObserver.observe(this.canvasContainer);\n    this.drawImage();\n    this.loop();\n    window.setTimeout(function () {\n      var initX = window.innerWidth / 2;\n      var initY = window.innerHeight / 2;\n\n      _this2.lazy.update({\n        x: initX - _this2.chainLength / 4,\n        y: initY\n      }, {\n        both: true\n      });\n\n      _this2.lazy.update({\n        x: initX + _this2.chainLength / 4,\n        y: initY\n      }, {\n        both: false\n      });\n\n      _this2.mouseHasMoved = true;\n      _this2.valuesChanged = true;\n\n      _this2.clearExceptErasedLines(); // Load saveData from prop if it exists\n\n\n      if (_this2.props.saveData) {\n        _this2.loadSaveData(_this2.props.saveData);\n      }\n    }, 100); // Attach our wheel event listener here instead of in the render so that we can specify a non-passive listener.\n    // This is necessary to prevent the default event action on chrome.\n    // https://github.com/facebook/react/issues/14856\n\n    this.canvas[\"interface\"] && this.canvas[\"interface\"].addEventListener(\"wheel\", this.handleWheel, makePassiveEventOption());\n  };\n\n  _proto.componentDidUpdate = function componentDidUpdate(prevProps) {\n    if (prevProps.lazyRadius !== this.props.lazyRadius) {\n      // Set new lazyRadius values\n      this.chainLength = this.props.lazyRadius * window.devicePixelRatio;\n      this.lazy.setRadius(this.props.lazyRadius * window.devicePixelRatio);\n    }\n\n    if (prevProps.saveData !== this.props.saveData) {\n      this.loadSaveData(this.props.saveData);\n    }\n\n    if (JSON.stringify(prevProps) !== JSON.stringify(this.props)) {\n      // Signal this.loop function that values changed\n      this.valuesChanged = true;\n    }\n\n    this.coordSystem.scaleExtents = this.props.zoomExtents;\n\n    if (!this.props.enablePanAndZoom) {\n      this.coordSystem.resetView();\n    }\n\n    if (prevProps.imgSrc !== this.props.imgSrc) {\n      this.drawImage();\n    }\n  };\n\n  _proto.render = function render() {\n    var _this3 = this;\n\n    return /*#__PURE__*/React.createElement(\"div\", {\n      className: this.props.className,\n      style: _extends({\n        display: \"block\",\n        background: this.props.backgroundColor,\n        touchAction: \"none\",\n        width: this.props.canvasWidth,\n        height: this.props.canvasHeight\n      }, this.props.style),\n      ref: function ref(container) {\n        if (container) {\n          _this3.canvasContainer = container;\n        }\n      }\n    }, canvasTypes.map(function (name) {\n      var isInterface = name === \"interface\";\n      return /*#__PURE__*/React.createElement(\"canvas\", {\n        key: name,\n        ref: function ref(canvas) {\n          if (canvas) {\n            _this3.canvas[name] = canvas;\n            _this3.ctx[name] = canvas.getContext(\"2d\");\n\n            if (isInterface) {\n              _this3.coordSystem.canvas = canvas;\n            }\n          }\n        },\n        style: _extends({}, canvasStyle),\n        onMouseDown: isInterface ? _this3.handleDrawStart : undefined,\n        onMouseMove: isInterface ? _this3.handleDrawMove : undefined,\n        onMouseUp: isInterface ? _this3.handleDrawEnd : undefined,\n        onMouseOut: isInterface ? _this3.handleDrawEnd : undefined,\n        onTouchStart: isInterface ? _this3.handleDrawStart : undefined,\n        onTouchMove: isInterface ? _this3.handleDrawMove : undefined,\n        onTouchEnd: isInterface ? _this3.handleDrawEnd : undefined,\n        onTouchCancel: isInterface ? _this3.handleDrawEnd : undefined\n      });\n    }));\n  } ///// Event Handlers\n  ;\n\n  return CanvasDraw;\n}(PureComponent);\n\n_defineProperty(CanvasDraw, \"defaultProps\", {\n  onChange: null,\n  loadTimeOffset: 5,\n  lazyRadius: 12,\n  brushRadius: 10,\n  brushColor: \"#444\",\n  catenaryColor: \"#0a0302\",\n  gridColor: \"rgba(150,150,150,0.17)\",\n  backgroundColor: \"#FFF\",\n  hideGrid: false,\n  canvasWidth: 400,\n  canvasHeight: 400,\n  disabled: false,\n  imgSrc: \"\",\n  saveData: \"\",\n  immediateLoading: false,\n  hideInterface: false,\n  gridSizeX: 25,\n  gridSizeY: 25,\n  gridLineWidth: 0.5,\n  hideGridX: false,\n  hideGridY: false,\n  enablePanAndZoom: false,\n  mouseZoomFactor: 0.01,\n  zoomExtents: {\n    min: 0.33,\n    max: 3\n  },\n  clampLinesToDocument: false\n});\n\nexport { CanvasDraw as default };\nCanvasDraw.propTypes = process.env.NODE_ENV !== \"production\" ? {\n  onChange: PropTypes.func,\n  loadTimeOffset: PropTypes.number,\n  lazyRadius: PropTypes.number,\n  brushRadius: PropTypes.number,\n  brushColor: PropTypes.string,\n  catenaryColor: PropTypes.string,\n  gridColor: PropTypes.string,\n  backgroundColor: PropTypes.string,\n  hideGrid: PropTypes.bool,\n  canvasWidth: dimensionsPropTypes,\n  canvasHeight: dimensionsPropTypes,\n  disabled: PropTypes.bool,\n  imgSrc: PropTypes.string,\n  saveData: PropTypes.string,\n  immediateLoading: PropTypes.bool,\n  hideInterface: PropTypes.bool,\n  gridSizeX: PropTypes.number,\n  gridSizeY: PropTypes.number,\n  gridLineWidth: PropTypes.number,\n  hideGridX: PropTypes.bool,\n  hideGridY: PropTypes.bool,\n  enablePanAndZoom: PropTypes.bool,\n  mouseZoomFactor: PropTypes.number,\n  zoomExtents: boundsProp,\n  clampLinesToDocument: PropTypes.bool\n} : {};","map":{"version":3,"sources":["/home/nsr/new2/skribbl-/chatfrontend/node_modules/react-canvas-draw/es/index.js"],"names":["_createForOfIteratorHelperLoose","o","allowArrayLike","it","Symbol","iterator","Array","isArray","_unsupportedIterableToArray","length","i","done","value","TypeError","next","bind","minLen","_arrayLikeToArray","n","Object","prototype","toString","call","slice","constructor","name","from","test","arr","len","arr2","_extends","assign","target","arguments","source","key","hasOwnProperty","apply","_assertThisInitialized","self","ReferenceError","_inheritsLoose","subClass","superClass","create","__proto__","_defineProperty","obj","defineProperty","enumerable","configurable","writable","React","PureComponent","PropTypes","LazyBrush","Catenary","ResizeObserver","CoordinateSystem","IDENTITY","drawImage","DefaultState","makePassiveEventOption","midPointBtw","p1","p2","x","y","canvasStyle","display","position","canvasTypes","dimensionsPropTypes","process","env","NODE_ENV","oneOfType","number","string","boundsProp","shape","min","isRequired","max","CanvasDraw","_PureComponent","props","_this","lines","erasedLines","pop","clearExceptErasedLines","simulateDrawingLines","immediate","triggerOnChange","push","concat","resetView","coordSystem","view","setView","JSON","stringify","width","canvasWidth","height","canvasHeight","fileType","useBgImage","backgroundColour","canvasToExport","canvas","drawing","context","getContext","storedImageData","getImageData","compositeOperation","globalCompositeOperation","imgSrc","fillStyle","fillRect","imageData","toDataURL","clearRect","putImageData","saveData","immediateLoading","Error","_JSON$parse","parse","clear","scaleX","scaleY","scaleAvg","map","line","points","p","brushRadius","canvasObserver","unobserve","canvasContainer","removeEventListener","handleWheel","e","interactionSM","handleMouseWheel","handleDrawStart","mouseHasMoved","handleDrawMove","handleDrawEnd","ctx","forEach","clearWindow","m","transformMatrix","setTransform","a","b","c","d","f","deferRedrawOnViewChange","drawGrid","grid","redrawImage","loop","once","entries","getSaveData","_iterator","_step","entry","_entry$contentRect","contentRect","setCanvasSize","temp","documentSize","loadSaveData","point","clampLinesToDocument","Math","image","complete","img","_ref","curTime","timeoutGap","loadTimeOffset","brushColor","drawPoints","saveLine","_loop","window","setTimeout","style","_ref2","lineJoin","lineCap","strokeStyle","lineWidth","moveTo","beginPath","midPoint","quadraticCurveTo","lineTo","stroke","_temp","_ref3","inClientSpace","onChange","valuesChanged","_temp2","_ref4","_ref4$once","pointer","lazy","getPointerCoordinates","brush","getBrushCoordinates","drawInterface","requestAnimationFrame","ctxs","action","save","restore","Image","crossOrigin","onload","src","hideGrid","gridSize","_this$coordSystem$can","canvasBounds","viewMin","viewMax","minx","floor","miny","maxx","maxy","setLineDash","gridColor","gridLineWidth","hideGridX","countX","gridSizeX","hideGridY","countY","gridSizeY","hideInterface","arc","PI","fill","catenaryColor","isEnabled","catenary","drawToCanvas","chainLength","isDrawing","isPressing","scaleExtents","zoomExtents","attachViewChangeListener","applyView","_proto","componentDidMount","_this2","radius","lazyRadius","devicePixelRatio","enabled","initialPoint","innerWidth","innerHeight","observer","handleCanvasResize","observe","initX","initY","update","both","addEventListener","componentDidUpdate","prevProps","setRadius","enablePanAndZoom","render","_this3","createElement","className","background","backgroundColor","touchAction","ref","container","isInterface","onMouseDown","undefined","onMouseMove","onMouseUp","onMouseOut","onTouchStart","onTouchMove","onTouchEnd","onTouchCancel","disabled","mouseZoomFactor","default","propTypes","func","bool"],"mappings":"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","sourcesContent":["function _createForOfIteratorHelperLoose(o, allowArrayLike) { var it; if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; return function () { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } it = o[Symbol.iterator](); return it.next.bind(it); }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return self; }\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React, { PureComponent } from \"react\";\nimport PropTypes from \"prop-types\";\nimport { LazyBrush } from \"lazy-brush\";\nimport { Catenary } from \"catenary-curve\";\nimport ResizeObserver from \"resize-observer-polyfill\";\nimport CoordinateSystem, { IDENTITY } from \"./coordinateSystem\";\nimport drawImage from \"./drawImage\";\nimport { DefaultState } from \"./interactionStateMachine\";\nimport makePassiveEventOption from \"./makePassiveEventOption\";\n\nfunction midPointBtw(p1, p2) {\n  return {\n    x: p1.x + (p2.x - p1.x) / 2,\n    y: p1.y + (p2.y - p1.y) / 2\n  };\n}\n\nvar canvasStyle = {\n  display: \"block\",\n  position: \"absolute\"\n}; // The order of these is important: grid > drawing > temp > interface\n\nvar canvasTypes = [\"grid\", \"drawing\", \"temp\", \"interface\"];\nvar dimensionsPropTypes = process.env.NODE_ENV !== \"production\" ? PropTypes.oneOfType([PropTypes.number, PropTypes.string]) : {};\nvar boundsProp = process.env.NODE_ENV !== \"production\" ? PropTypes.shape({\n  min: PropTypes.number.isRequired,\n  max: PropTypes.number.isRequired\n}) : {};\n\nvar CanvasDraw = /*#__PURE__*/function (_PureComponent) {\n  _inheritsLoose(CanvasDraw, _PureComponent);\n\n  ///// public API /////////////////////////////////////////////////////////////\n  function CanvasDraw(props) {\n    var _this;\n\n    _this = _PureComponent.call(this, props) || this;\n\n    _defineProperty(_assertThisInitialized(_this), \"undo\", function () {\n      var lines = [];\n\n      if (_this.lines.length) {\n        lines = _this.lines.slice(0, -1);\n      } else if (_this.erasedLines.length) {\n        lines = _this.erasedLines.pop();\n      }\n\n      _this.clearExceptErasedLines();\n\n      _this.simulateDrawingLines({\n        lines: lines,\n        immediate: true\n      });\n\n      _this.triggerOnChange();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"eraseAll\", function () {\n      _this.erasedLines.push([].concat(_this.lines));\n\n      _this.clearExceptErasedLines();\n\n      _this.triggerOnChange();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"clear\", function () {\n      _this.erasedLines = [];\n\n      _this.clearExceptErasedLines();\n\n      _this.resetView();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"resetView\", function () {\n      return _this.coordSystem.resetView();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"setView\", function (view) {\n      return _this.coordSystem.setView(view);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getSaveData\", function () {\n      // Construct and return the stringified saveData object\n      return JSON.stringify({\n        lines: _this.lines,\n        width: _this.props.canvasWidth,\n        height: _this.props.canvasHeight\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getDataURL\", function (fileType, useBgImage, backgroundColour) {\n      // Get a reference to the \"drawing\" layer of the canvas\n      var canvasToExport = _this.canvas.drawing;\n      var context = canvasToExport.getContext(\"2d\"); //cache height and width\n\n      var width = canvasToExport.width;\n      var height = canvasToExport.height; //get the current ImageData for the canvas\n\n      var storedImageData = context.getImageData(0, 0, width, height); //store the current globalCompositeOperation\n\n      var compositeOperation = context.globalCompositeOperation; //set to draw behind current content\n\n      context.globalCompositeOperation = \"destination-over\"; // If \"useBgImage\" has been set to true, this takes precedence over the background colour parameter\n\n      if (useBgImage) {\n        if (!_this.props.imgSrc) return \"Background image source not set\"; // Write the background image\n\n        _this.drawImage();\n      } else if (backgroundColour != null) {\n        //set background color\n        context.fillStyle = backgroundColour; //fill entire canvas with background colour\n\n        context.fillRect(0, 0, width, height);\n      } // If the file type has not been specified, default to PNG\n\n\n      if (!fileType) fileType = \"png\"; // Export the canvas to data URL\n\n      var imageData = canvasToExport.toDataURL(\"image/\" + fileType); //clear the canvas\n\n      context.clearRect(0, 0, width, height); //restore it with original / cached ImageData\n\n      context.putImageData(storedImageData, 0, 0); //reset the globalCompositeOperation to what it was\n\n      context.globalCompositeOperation = compositeOperation;\n      return imageData;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"loadSaveData\", function (saveData, immediate) {\n      if (immediate === void 0) {\n        immediate = _this.props.immediateLoading;\n      }\n\n      if (typeof saveData !== \"string\") {\n        throw new Error(\"saveData needs to be of type string!\");\n      }\n\n      var _JSON$parse = JSON.parse(saveData),\n          lines = _JSON$parse.lines,\n          width = _JSON$parse.width,\n          height = _JSON$parse.height;\n\n      if (!lines || typeof lines.push !== \"function\") {\n        throw new Error(\"saveData.lines needs to be an array!\");\n      }\n\n      _this.clear();\n\n      if (width === _this.props.canvasWidth && height === _this.props.canvasHeight) {\n        _this.simulateDrawingLines({\n          lines: lines,\n          immediate: immediate\n        });\n      } else {\n        // we need to rescale the lines based on saved & current dimensions\n        var scaleX = _this.props.canvasWidth / width;\n        var scaleY = _this.props.canvasHeight / height;\n        var scaleAvg = (scaleX + scaleY) / 2;\n\n        _this.simulateDrawingLines({\n          lines: lines.map(function (line) {\n            return _extends({}, line, {\n              points: line.points.map(function (p) {\n                return {\n                  x: p.x * scaleX,\n                  y: p.y * scaleY\n                };\n              }),\n              brushRadius: line.brushRadius * scaleAvg\n            });\n          }),\n          immediate: immediate\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"componentWillUnmount\", function () {\n      _this.canvasObserver.unobserve(_this.canvasContainer);\n\n      _this.canvas[\"interface\"] && _this.canvas[\"interface\"].removeEventListener(\"wheel\", _this.handleWheel);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleWheel\", function (e) {\n      _this.interactionSM = _this.interactionSM.handleMouseWheel(e, _assertThisInitialized(_this));\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleDrawStart\", function (e) {\n      _this.interactionSM = _this.interactionSM.handleDrawStart(e, _assertThisInitialized(_this));\n      _this.mouseHasMoved = true;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleDrawMove\", function (e) {\n      _this.interactionSM = _this.interactionSM.handleDrawMove(e, _assertThisInitialized(_this));\n      _this.mouseHasMoved = true;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleDrawEnd\", function (e) {\n      _this.interactionSM = _this.interactionSM.handleDrawEnd(e, _assertThisInitialized(_this));\n      _this.mouseHasMoved = true;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"applyView\", function () {\n      if (!_this.ctx.drawing) {\n        return;\n      }\n\n      canvasTypes.map(function (name) {\n        return _this.ctx[name];\n      }).forEach(function (ctx) {\n        _this.clearWindow(ctx);\n\n        var m = _this.coordSystem.transformMatrix;\n        ctx.setTransform(m.a, m.b, m.c, m.d, m.e, m.f);\n      });\n\n      if (!_this.deferRedrawOnViewChange) {\n        _this.drawGrid(_this.ctx.grid);\n\n        _this.redrawImage();\n\n        _this.loop({\n          once: true\n        });\n\n        var lines = _this.lines;\n        _this.lines = [];\n\n        _this.simulateDrawingLines({\n          lines: lines,\n          immediate: true\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleCanvasResize\", function (entries) {\n      var saveData = _this.getSaveData();\n\n      _this.deferRedrawOnViewChange = true;\n\n      try {\n        for (var _iterator = _createForOfIteratorHelperLoose(entries), _step; !(_step = _iterator()).done;) {\n          var entry = _step.value;\n          var _entry$contentRect = entry.contentRect,\n              width = _entry$contentRect.width,\n              height = _entry$contentRect.height;\n\n          _this.setCanvasSize(_this.canvas[\"interface\"], width, height);\n\n          _this.setCanvasSize(_this.canvas.drawing, width, height);\n\n          _this.setCanvasSize(_this.canvas.temp, width, height);\n\n          _this.setCanvasSize(_this.canvas.grid, width, height);\n\n          _this.coordSystem.documentSize = {\n            width: width,\n            height: height\n          };\n\n          _this.drawGrid(_this.ctx.grid);\n\n          _this.drawImage();\n\n          _this.loop({\n            once: true\n          });\n        }\n\n        _this.loadSaveData(saveData, true);\n      } finally {\n        _this.deferRedrawOnViewChange = false;\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"clampPointToDocument\", function (point) {\n      if (_this.props.clampLinesToDocument) {\n        return {\n          x: Math.max(Math.min(point.x, _this.props.canvasWidth), 0),\n          y: Math.max(Math.min(point.y, _this.props.canvasHeight), 0)\n        };\n      } else {\n        return point;\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"redrawImage\", function () {\n      _this.image && _this.image.complete && drawImage({\n        ctx: _this.ctx.grid,\n        img: _this.image\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"simulateDrawingLines\", function (_ref) {\n      var lines = _ref.lines,\n          immediate = _ref.immediate;\n      // Simulate live-drawing of the loaded lines\n      // TODO use a generator\n      var curTime = 0;\n      var timeoutGap = immediate ? 0 : _this.props.loadTimeOffset;\n      lines.forEach(function (line) {\n        var points = line.points,\n            brushColor = line.brushColor,\n            brushRadius = line.brushRadius; // Draw all at once if immediate flag is set, instead of using setTimeout\n\n        if (immediate) {\n          // Draw the points\n          _this.drawPoints({\n            points: points,\n            brushColor: brushColor,\n            brushRadius: brushRadius\n          }); // Save line with the drawn points\n\n\n          _this.points = points;\n\n          _this.saveLine({\n            brushColor: brushColor,\n            brushRadius: brushRadius\n          });\n\n          return;\n        } // Use timeout to draw\n\n\n        var _loop = function _loop(i) {\n          curTime += timeoutGap;\n          window.setTimeout(function () {\n            _this.drawPoints({\n              points: points.slice(0, i + 1),\n              brushColor: brushColor,\n              brushRadius: brushRadius\n            });\n          }, curTime);\n        };\n\n        for (var i = 1; i < points.length; i++) {\n          _loop(i);\n        }\n\n        curTime += timeoutGap;\n        window.setTimeout(function () {\n          // Save this line with its props instead of this.props\n          _this.points = points;\n\n          _this.saveLine({\n            brushColor: brushColor,\n            brushRadius: brushRadius\n          });\n        }, curTime);\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"setCanvasSize\", function (canvas, width, height) {\n      canvas.width = width;\n      canvas.height = height;\n      canvas.style.width = width;\n      canvas.style.height = height;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"drawPoints\", function (_ref2) {\n      var points = _ref2.points,\n          brushColor = _ref2.brushColor,\n          brushRadius = _ref2.brushRadius;\n      _this.ctx.temp.lineJoin = \"round\";\n      _this.ctx.temp.lineCap = \"round\";\n      _this.ctx.temp.strokeStyle = brushColor;\n\n      _this.clearWindow(_this.ctx.temp);\n\n      _this.ctx.temp.lineWidth = brushRadius * 2;\n      var p1 = points[0];\n      var p2 = points[1];\n\n      _this.ctx.temp.moveTo(p2.x, p2.y);\n\n      _this.ctx.temp.beginPath();\n\n      for (var i = 1, len = points.length; i < len; i++) {\n        // we pick the point between pi+1 & pi+2 as the\n        // end point and p1 as our control point\n        var midPoint = midPointBtw(p1, p2);\n\n        _this.ctx.temp.quadraticCurveTo(p1.x, p1.y, midPoint.x, midPoint.y);\n\n        p1 = points[i];\n        p2 = points[i + 1];\n      } // Draw last line as a straight line while\n      // we wait for the next point to be able to calculate\n      // the bezier control point\n\n\n      _this.ctx.temp.lineTo(p1.x, p1.y);\n\n      _this.ctx.temp.stroke();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"saveLine\", function (_temp) {\n      var _ref3 = _temp === void 0 ? {} : _temp,\n          brushColor = _ref3.brushColor,\n          brushRadius = _ref3.brushRadius;\n\n      if (_this.points.length < 2) return; // Save as new line\n\n      _this.lines.push({\n        points: [].concat(_this.points),\n        brushColor: brushColor || _this.props.brushColor,\n        brushRadius: brushRadius || _this.props.brushRadius\n      }); // Reset points array\n\n\n      _this.points.length = 0; // Copy the line to the drawing canvas\n\n      _this.inClientSpace([_this.ctx.drawing, _this.ctx.temp], function () {\n        _this.ctx.drawing.drawImage(_this.canvas.temp, 0, 0, _this.canvas.drawing.width, _this.canvas.drawing.height);\n      }); // Clear the temporary line-drawing canvas\n\n\n      _this.clearWindow(_this.ctx.temp);\n\n      _this.triggerOnChange();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"triggerOnChange\", function () {\n      _this.props.onChange && _this.props.onChange(_assertThisInitialized(_this));\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"clearWindow\", function (ctx) {\n      _this.inClientSpace([ctx], function () {\n        return ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"clearExceptErasedLines\", function () {\n      _this.lines = [];\n      _this.valuesChanged = true;\n\n      _this.clearWindow(_this.ctx.drawing);\n\n      _this.clearWindow(_this.ctx.temp);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"loop\", function (_temp2) {\n      var _ref4 = _temp2 === void 0 ? {} : _temp2,\n          _ref4$once = _ref4.once,\n          once = _ref4$once === void 0 ? false : _ref4$once;\n\n      if (_this.mouseHasMoved || _this.valuesChanged) {\n        var pointer = _this.lazy.getPointerCoordinates();\n\n        var brush = _this.lazy.getBrushCoordinates();\n\n        _this.drawInterface(_this.ctx[\"interface\"], pointer, brush);\n\n        _this.mouseHasMoved = false;\n        _this.valuesChanged = false;\n      }\n\n      if (!once) {\n        window.requestAnimationFrame(function () {\n          _this.loop();\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"inClientSpace\", function (ctxs, action) {\n      ctxs.forEach(function (ctx) {\n        ctx.save();\n        ctx.setTransform(IDENTITY.a, IDENTITY.b, IDENTITY.c, IDENTITY.d, IDENTITY.e, IDENTITY.f);\n      });\n\n      try {\n        action();\n      } finally {\n        ctxs.forEach(function (ctx) {\n          return ctx.restore();\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"drawImage\", function () {\n      if (!_this.props.imgSrc) return; // Load the image\n\n      _this.image = new Image(); // Prevent SecurityError \"Tainted canvases may not be exported.\" #70\n\n      _this.image.crossOrigin = \"anonymous\"; // Draw the image once loaded\n\n      _this.image.onload = _this.redrawImage;\n      _this.image.src = _this.props.imgSrc;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"drawGrid\", function (ctx) {\n      if (_this.props.hideGrid) return;\n\n      _this.clearWindow(ctx);\n\n      var gridSize = 25;\n      var _this$coordSystem$can = _this.coordSystem.canvasBounds,\n          viewMin = _this$coordSystem$can.viewMin,\n          viewMax = _this$coordSystem$can.viewMax;\n      var minx = Math.floor(viewMin.x / gridSize - 1) * gridSize;\n      var miny = Math.floor(viewMin.y / gridSize - 1) * gridSize;\n      var maxx = viewMax.x + gridSize;\n      var maxy = viewMax.y + gridSize;\n      ctx.beginPath();\n      ctx.setLineDash([5, 1]);\n      ctx.setLineDash([]);\n      ctx.strokeStyle = _this.props.gridColor;\n      ctx.lineWidth = _this.props.gridLineWidth;\n\n      if (!_this.props.hideGridX) {\n        var countX = minx;\n        var gridSizeX = _this.props.gridSizeX;\n\n        while (countX < maxx) {\n          countX += gridSizeX;\n          ctx.moveTo(countX, miny);\n          ctx.lineTo(countX, maxy);\n        }\n\n        ctx.stroke();\n      }\n\n      if (!_this.props.hideGridY) {\n        var countY = miny;\n        var gridSizeY = _this.props.gridSizeY;\n\n        while (countY < maxy) {\n          countY += gridSizeY;\n          ctx.moveTo(minx, countY);\n          ctx.lineTo(maxx, countY);\n        }\n\n        ctx.stroke();\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"drawInterface\", function (ctx, pointer, brush) {\n      if (_this.props.hideInterface) return;\n\n      _this.clearWindow(ctx); // Draw brush preview\n\n\n      ctx.beginPath();\n      ctx.fillStyle = _this.props.brushColor;\n      ctx.arc(brush.x, brush.y, _this.props.brushRadius, 0, Math.PI * 2, true);\n      ctx.fill(); // Draw mouse point (the one directly at the cursor)\n\n      ctx.beginPath();\n      ctx.fillStyle = _this.props.catenaryColor;\n      ctx.arc(pointer.x, pointer.y, 4, 0, Math.PI * 2, true);\n      ctx.fill(); // Draw catenary\n\n      if (_this.lazy.isEnabled()) {\n        ctx.beginPath();\n        ctx.lineWidth = 2;\n        ctx.lineCap = \"round\";\n        ctx.setLineDash([2, 4]);\n        ctx.strokeStyle = _this.props.catenaryColor;\n\n        _this.catenary.drawToCanvas(_this.ctx[\"interface\"], brush, pointer, _this.chainLength);\n\n        ctx.stroke();\n      } // Draw brush point (the one in the middle of the brush preview)\n\n\n      ctx.beginPath();\n      ctx.fillStyle = _this.props.catenaryColor;\n      ctx.arc(brush.x, brush.y, 2, 0, Math.PI * 2, true);\n      ctx.fill();\n    });\n\n    _this.canvas = {};\n    _this.ctx = {};\n    _this.catenary = new Catenary();\n    _this.points = [];\n    _this.lines = [];\n    _this.erasedLines = [];\n    _this.mouseHasMoved = true;\n    _this.valuesChanged = true;\n    _this.isDrawing = false;\n    _this.isPressing = false;\n    _this.deferRedrawOnViewChange = false;\n    _this.interactionSM = new DefaultState();\n    _this.coordSystem = new CoordinateSystem({\n      scaleExtents: props.zoomExtents,\n      documentSize: {\n        width: props.canvasWidth,\n        height: props.canvasHeight\n      }\n    });\n\n    _this.coordSystem.attachViewChangeListener(_this.applyView.bind(_assertThisInitialized(_this)));\n\n    return _this;\n  }\n\n  var _proto = CanvasDraw.prototype;\n\n  ///// private API ////////////////////////////////////////////////////////////\n  ///// React Lifecycle\n  _proto.componentDidMount = function componentDidMount() {\n    var _this2 = this;\n\n    this.lazy = new LazyBrush({\n      radius: this.props.lazyRadius * window.devicePixelRatio,\n      enabled: true,\n      initialPoint: {\n        x: window.innerWidth / 2,\n        y: window.innerHeight / 2\n      }\n    });\n    this.chainLength = this.props.lazyRadius * window.devicePixelRatio;\n    this.canvasObserver = new ResizeObserver(function (entries, observer) {\n      return _this2.handleCanvasResize(entries, observer);\n    });\n    this.canvasObserver.observe(this.canvasContainer);\n    this.drawImage();\n    this.loop();\n    window.setTimeout(function () {\n      var initX = window.innerWidth / 2;\n      var initY = window.innerHeight / 2;\n\n      _this2.lazy.update({\n        x: initX - _this2.chainLength / 4,\n        y: initY\n      }, {\n        both: true\n      });\n\n      _this2.lazy.update({\n        x: initX + _this2.chainLength / 4,\n        y: initY\n      }, {\n        both: false\n      });\n\n      _this2.mouseHasMoved = true;\n      _this2.valuesChanged = true;\n\n      _this2.clearExceptErasedLines(); // Load saveData from prop if it exists\n\n\n      if (_this2.props.saveData) {\n        _this2.loadSaveData(_this2.props.saveData);\n      }\n    }, 100); // Attach our wheel event listener here instead of in the render so that we can specify a non-passive listener.\n    // This is necessary to prevent the default event action on chrome.\n    // https://github.com/facebook/react/issues/14856\n\n    this.canvas[\"interface\"] && this.canvas[\"interface\"].addEventListener(\"wheel\", this.handleWheel, makePassiveEventOption());\n  };\n\n  _proto.componentDidUpdate = function componentDidUpdate(prevProps) {\n    if (prevProps.lazyRadius !== this.props.lazyRadius) {\n      // Set new lazyRadius values\n      this.chainLength = this.props.lazyRadius * window.devicePixelRatio;\n      this.lazy.setRadius(this.props.lazyRadius * window.devicePixelRatio);\n    }\n\n    if (prevProps.saveData !== this.props.saveData) {\n      this.loadSaveData(this.props.saveData);\n    }\n\n    if (JSON.stringify(prevProps) !== JSON.stringify(this.props)) {\n      // Signal this.loop function that values changed\n      this.valuesChanged = true;\n    }\n\n    this.coordSystem.scaleExtents = this.props.zoomExtents;\n\n    if (!this.props.enablePanAndZoom) {\n      this.coordSystem.resetView();\n    }\n\n    if (prevProps.imgSrc !== this.props.imgSrc) {\n      this.drawImage();\n    }\n  };\n\n  _proto.render = function render() {\n    var _this3 = this;\n\n    return /*#__PURE__*/React.createElement(\"div\", {\n      className: this.props.className,\n      style: _extends({\n        display: \"block\",\n        background: this.props.backgroundColor,\n        touchAction: \"none\",\n        width: this.props.canvasWidth,\n        height: this.props.canvasHeight\n      }, this.props.style),\n      ref: function ref(container) {\n        if (container) {\n          _this3.canvasContainer = container;\n        }\n      }\n    }, canvasTypes.map(function (name) {\n      var isInterface = name === \"interface\";\n      return /*#__PURE__*/React.createElement(\"canvas\", {\n        key: name,\n        ref: function ref(canvas) {\n          if (canvas) {\n            _this3.canvas[name] = canvas;\n            _this3.ctx[name] = canvas.getContext(\"2d\");\n\n            if (isInterface) {\n              _this3.coordSystem.canvas = canvas;\n            }\n          }\n        },\n        style: _extends({}, canvasStyle),\n        onMouseDown: isInterface ? _this3.handleDrawStart : undefined,\n        onMouseMove: isInterface ? _this3.handleDrawMove : undefined,\n        onMouseUp: isInterface ? _this3.handleDrawEnd : undefined,\n        onMouseOut: isInterface ? _this3.handleDrawEnd : undefined,\n        onTouchStart: isInterface ? _this3.handleDrawStart : undefined,\n        onTouchMove: isInterface ? _this3.handleDrawMove : undefined,\n        onTouchEnd: isInterface ? _this3.handleDrawEnd : undefined,\n        onTouchCancel: isInterface ? _this3.handleDrawEnd : undefined\n      });\n    }));\n  } ///// Event Handlers\n  ;\n\n  return CanvasDraw;\n}(PureComponent);\n\n_defineProperty(CanvasDraw, \"defaultProps\", {\n  onChange: null,\n  loadTimeOffset: 5,\n  lazyRadius: 12,\n  brushRadius: 10,\n  brushColor: \"#444\",\n  catenaryColor: \"#0a0302\",\n  gridColor: \"rgba(150,150,150,0.17)\",\n  backgroundColor: \"#FFF\",\n  hideGrid: false,\n  canvasWidth: 400,\n  canvasHeight: 400,\n  disabled: false,\n  imgSrc: \"\",\n  saveData: \"\",\n  immediateLoading: false,\n  hideInterface: false,\n  gridSizeX: 25,\n  gridSizeY: 25,\n  gridLineWidth: 0.5,\n  hideGridX: false,\n  hideGridY: false,\n  enablePanAndZoom: false,\n  mouseZoomFactor: 0.01,\n  zoomExtents: {\n    min: 0.33,\n    max: 3\n  },\n  clampLinesToDocument: false\n});\n\nexport { CanvasDraw as default };\nCanvasDraw.propTypes = process.env.NODE_ENV !== \"production\" ? {\n  onChange: PropTypes.func,\n  loadTimeOffset: PropTypes.number,\n  lazyRadius: PropTypes.number,\n  brushRadius: PropTypes.number,\n  brushColor: PropTypes.string,\n  catenaryColor: PropTypes.string,\n  gridColor: PropTypes.string,\n  backgroundColor: PropTypes.string,\n  hideGrid: PropTypes.bool,\n  canvasWidth: dimensionsPropTypes,\n  canvasHeight: dimensionsPropTypes,\n  disabled: PropTypes.bool,\n  imgSrc: PropTypes.string,\n  saveData: PropTypes.string,\n  immediateLoading: PropTypes.bool,\n  hideInterface: PropTypes.bool,\n  gridSizeX: PropTypes.number,\n  gridSizeY: PropTypes.number,\n  gridLineWidth: PropTypes.number,\n  hideGridX: PropTypes.bool,\n  hideGridY: PropTypes.bool,\n  enablePanAndZoom: PropTypes.bool,\n  mouseZoomFactor: PropTypes.number,\n  zoomExtents: boundsProp,\n  clampLinesToDocument: PropTypes.bool\n} : {};"]},"metadata":{},"sourceType":"module"}